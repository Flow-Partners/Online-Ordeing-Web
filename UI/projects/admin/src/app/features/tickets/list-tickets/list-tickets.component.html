<div class="list-tickets-container">
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="page-title">
          <i class="bi bi-ticket-perforated me-2"></i>
          Ticket Management
        </h2>
        <p class="text-muted mb-0">View and manage all tickets with complete order and customer information</p>
      </div>
    </div>
  </div>

  <!-- Status Tabs -->
  <div class="card mb-4">
    <div class="card-body p-0">
      <ul class="nav nav-tabs status-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            [class.active]="statusFilter === 'all'"
            (click)="setStatusFilter('all')"
            type="button">
            <i class="bi bi-list-ul me-2"></i>
            All Tickets
            <span class="badge bg-secondary ms-2" *ngIf="getTicketCount('all') > 0">
              {{ getTicketCount('all') }}
            </span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            [class.active]="statusFilter === 'open'"
            (click)="setStatusFilter('open')"
            type="button">
            <i class="bi bi-circle me-2"></i>
            Open
            <span class="badge bg-success ms-2" *ngIf="getTicketCount('open') > 0">
              {{ getTicketCount('open') }}
            </span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            [class.active]="statusFilter === 'accept'"
            (click)="setStatusFilter('accept')"
            type="button">
            <i class="bi bi-check-circle me-2"></i>
            Accept
            <span class="badge bg-warning ms-2" *ngIf="getTicketCount('accept') > 0">
              {{ getTicketCount('accept') }}
            </span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            [class.active]="statusFilter === 'closed'"
            (click)="setStatusFilter('closed')"
            type="button">
            <i class="bi bi-x-circle me-2"></i>
            Closed
            <span class="badge bg-secondary ms-2" *ngIf="getTicketCount('closed') > 0">
              {{ getTicketCount('closed') }}
            </span>
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-3">Loading tickets...</p>
  </div>

  <!-- Tickets List -->
  <div class="card" *ngIf="!isLoading">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 120px;">Ticket #</th>
              <th style="width: 150px;">Date</th>
              <th>Customer</th>
              <th style="width: 120px;" class="text-end">Total Amount</th>
              <th style="width: 120px;" class="text-end">Remaining</th>
              <th style="width: 100px;">Orders</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="tickets.length === 0">
              <td colspan="8" class="text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
                <p class="text-muted mb-0">No tickets found</p>
              </td>
            </tr>
            <tr *ngFor="let ticket of tickets">
              <td>
                <strong class="text-primary">{{ ticket.ticketNumber || 'N/A' }}</strong>
              </td>
              <td>
                <small>{{ formatDate(ticket.date) }}</small>
              </td>
              <td>
                <div>
                  <strong>{{ getCustomerName(ticket) }}</strong>
                  <br>
                  <small class="text-muted" *ngIf="ticket.customer">
                    <i class="bi bi-telephone me-1"></i>
                    {{ getCustomerPhone(ticket) }}
                  </small>
                </div>
              </td>
              <td class="text-end">
                <strong class="text-success">{{ formatCurrency(ticket.totalAmount) }}</strong>
              </td>
              <td class="text-end">
                <span class="text-muted">{{ formatCurrency(ticket.remainingAmount) }}</span>
              </td>
              <td>
                <span class="badge bg-info">{{ ticket.orders?.length || 0 }}</span>
              </td>
              <td>
                <select
                  class="form-select form-select-sm status-dropdown"
                  [ngClass]="getStatusBadgeClass(ticket)"
                  [disabled]="isUpdating(ticket.id)"
                  [value]="getCurrentStatus(ticket)"
                  (change)="onStatusChange(ticket, $event)">
                  <option value="open">Open</option>
                  <option value="accept">Accept</option>
                  <option value="closed">Closed</option>
                </select>
                <span *ngIf="isUpdating(ticket.id)" class="ms-2">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </span>
              </td>
              <td>
                <button
                  class="btn btn-sm btn-outline-primary"
                  (click)="viewTicket(ticket)"
                  title="View Ticket Details">
                  <i class="bi bi-eye"></i> View
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- View Ticket Modal -->
<div class="modal fade" [class.show]="showViewModal" [style.display]="showViewModal ? 'block' : 'none'" 
     tabindex="-1" *ngIf="selectedTicket">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-ticket-perforated me-2"></i>
          Ticket Details - {{ selectedTicket.ticketNumber }}
        </h5>
        <button type="button" class="btn-close" (click)="closeViewModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Ticket Information -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Ticket Information</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <strong>Ticket Number:</strong>
                <p class="mb-0">{{ selectedTicket.ticketNumber || 'N/A' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Status:</strong>
                <p class="mb-0">
                  <span class="badge" [ngClass]="getStatusBadgeClass(selectedTicket)">
                    {{ getStatusText(selectedTicket) }}
                  </span>
                  <span class="badge bg-warning ms-2" *ngIf="selectedTicket.isLocked">Locked</span>
                </p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Date:</strong>
                <p class="mb-0">{{ formatDate(selectedTicket.date) }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Last Update:</strong>
                <p class="mb-0">{{ formatDate(selectedTicket.lastUpdateTime) }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Total Amount:</strong>
                <p class="mb-0 text-success"><strong>{{ formatCurrency(selectedTicket.totalAmount) }}</strong></p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Remaining Amount:</strong>
                <p class="mb-0 text-muted">{{ formatCurrency(selectedTicket.remainingAmount) }}</p>
              </div>
              <div class="col-md-12 mb-3" *ngIf="selectedTicket.note">
                <strong>Note:</strong>
                <p class="mb-0">{{ selectedTicket.note }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="card mb-3" *ngIf="selectedTicket.customer">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="bi bi-person me-2"></i>Customer Information</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <strong>Name:</strong>
                <p class="mb-0">{{ getCustomerName(selectedTicket) }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Phone:</strong>
                <p class="mb-0">{{ getCustomerPhone(selectedTicket) }}</p>
              </div>
              <div class="col-md-6 mb-3" *ngIf="selectedTicket.customer.email">
                <strong>Email:</strong>
                <p class="mb-0">{{ getCustomerEmail(selectedTicket) }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Mobile:</strong>
                <p class="mb-0">{{ selectedTicket.customer.mobile || 'N/A' }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Loyalty Points:</strong>
                <p class="mb-0">{{ selectedTicket.customer.loyaltyPoints }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Total Orders:</strong>
                <p class="mb-0">{{ selectedTicket.customer.totalOrders }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Total Spent:</strong>
                <p class="mb-0 text-success">{{ formatCurrency(selectedTicket.customer.totalSpent) }}</p>
              </div>
              <div class="col-md-6 mb-3">
                <strong>Status:</strong>
                <p class="mb-0">
                  <span class="badge" [ngClass]="selectedTicket.customer.isActive ? 'bg-success' : 'bg-secondary'">
                    {{ selectedTicket.customer.isActive ? 'Active' : 'Inactive' }}
                  </span>
                  <span class="badge bg-info ms-2" *ngIf="selectedTicket.customer.isVerified">Verified</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Address -->
        <div class="card mb-3" *ngIf="selectedTicket.customerAddress">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Delivery Address</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-12 mb-2">
                <strong>Address:</strong>
                <p class="mb-0">{{ getAddressString(selectedTicket) }}</p>
              </div>
              <div class="col-md-6 mb-2" *ngIf="selectedTicket.customerAddress.contactName">
                <strong>Contact Name:</strong>
                <p class="mb-0">{{ selectedTicket.customerAddress.contactName }}</p>
              </div>
              <div class="col-md-6 mb-2" *ngIf="selectedTicket.customerAddress.contactPhone">
                <strong>Contact Phone:</strong>
                <p class="mb-0">{{ selectedTicket.customerAddress.contactPhone }}</p>
              </div>
              <div class="col-md-12 mb-2" *ngIf="selectedTicket.customerAddress.deliveryInstructions">
                <strong>Delivery Instructions:</strong>
                <p class="mb-0">{{ selectedTicket.customerAddress.deliveryInstructions }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Information -->
        <div class="card">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <i class="bi bi-cart me-2"></i>
              Orders ({{ selectedTicket.orders?.length || 0 }})
            </h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Menu Item</th>
                    <th>Portion</th>
                    <th class="text-end">Price</th>
                    <th class="text-end">Quantity</th>
                    <th class="text-end">Total</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="!selectedTicket.orders || selectedTicket.orders.length === 0">
                    <td colspan="6" class="text-center py-3 text-muted">No orders found</td>
                  </tr>
                  <tr *ngFor="let order of selectedTicket.orders">
                    <td>
                      <strong>{{ order.menuItemName }}</strong>
                    </td>
                    <td>
                      <span class="badge bg-info" *ngIf="order.portionName">
                        {{ order.portionName }}
                      </span>
                      <span class="text-muted" *ngIf="!order.portionName">-</span>
                    </td>
                    <td class="text-end">{{ formatCurrency(order.price) }}</td>
                    <td class="text-end">{{ order.quantity }}</td>
                    <td class="text-end">
                      <strong>{{ formatCurrency(order.price * order.quantity) }}</strong>
                    </td>
                    <td>
                      <small>{{ formatDate(order.createdDateTime) }}</small>
                    </td>
                  </tr>
                </tbody>
                <tfoot class="table-light" *ngIf="selectedTicket.orders && selectedTicket.orders.length > 0">
                  <tr>
                    <td colspan="4" class="text-end"><strong>Grand Total:</strong></td>
                    <td class="text-end">
                      <strong class="text-success fs-5">{{ formatCurrency(selectedTicket.totalAmount) }}</strong>
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeViewModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showViewModal" *ngIf="showViewModal" (click)="closeViewModal()"></div>

