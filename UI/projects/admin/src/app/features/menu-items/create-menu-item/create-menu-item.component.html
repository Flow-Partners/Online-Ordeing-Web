<div class="create-menu-item-container">
  <div class="page-header mb-4">
    <h2 class="page-title">
      <i [class]="isEditMode ? 'bi bi-pencil me-2' : 'bi bi-plus-circle me-2'"></i>
      {{ isEditMode ? 'Edit Menu Item' : 'Create Menu Item' }}
    </h2>
    <p class="text-muted mb-0">{{ isEditMode ? 'Update menu item with pricing and portion details' : 'Add a new menu item with pricing and portion details' }}</p>
  </div>

  <!-- Loading State for Menu Item -->
  <div *ngIf="isLoadingMenuItem" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-3">Loading menu item...</p>
  </div>

  <form [formGroup]="menuItemForm" (ngSubmit)="onSubmit()" *ngIf="!isLoadingMenuItem">
    <!-- Basic Information -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-info-circle me-2"></i>
          Basic Information
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Category -->
          <div class="col-12 col-md-6">
            <label for="categoryId" class="form-label">
              Category <span class="text-danger">*</span>
            </label>
            <div class="position-relative">
              <input
                type="text"
                class="form-control"
                id="categoryId"
                [value]="categorySearchText || getSelectedCategoryName()"
                (input)="onCategorySearch($event)"
                (focus)="onCategoryInputFocus()"
                (blur)="onCategoryInputBlur()"
                placeholder="{{ isLoadingCategories ? 'Loading categories...' : 'Type to search or create a category' }}"
                [class.is-invalid]="f['categoryId'].invalid && f['categoryId'].touched"
                [disabled]="isLoadingCategories || isCreatingCategory"
                autocomplete="off">
              <div class="invalid-feedback d-block" *ngIf="f['categoryId'].invalid && f['categoryId'].touched">
                Category is required
              </div>
              
              <!-- Loading indicator -->
              <div *ngIf="isCreatingCategory" class="position-absolute top-50 end-0 translate-middle-y pe-3">
                <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
              </div>
              
              <!-- Dropdown List -->
              <div
                class="dropdown-menu show position-absolute w-100"
                style="max-height: 300px; overflow-y: auto; z-index: 1000;"
                *ngIf="showCategoryDropdown && (filteredCategories.length > 0 || shouldShowCreateOption())">
                <!-- Existing categories -->
                <a
                  *ngFor="let category of filteredCategories"
                  class="dropdown-item"
                  (mousedown)="selectCategory(category)"
                  [class.active]="category.id === menuItemForm.get('categoryId')?.value"
                  style="cursor: pointer;">
                  <i class="bi bi-tag me-2"></i>
                  {{ category.name }}
                </a>
                
                <!-- Create new category option -->
                <div
                  *ngIf="shouldShowCreateOption()"
                  class="dropdown-divider"></div>
                <a
                  *ngIf="shouldShowCreateOption()"
                  class="dropdown-item text-primary fw-bold"
                  (mousedown)="createNewCategory()"
                  style="cursor: pointer;">
                  <i class="bi bi-plus-circle me-2"></i>
                  Create "{{ categorySearchText }}"
                </a>
              </div>
              
              <!-- No results message -->
              <div
                class="dropdown-menu show position-absolute w-100"
                style="z-index: 1000;"
                *ngIf="showCategoryDropdown && filteredCategories.length === 0 && !shouldShowCreateOption() && categorySearchText.trim() !== ''">
                <div class="dropdown-item-text text-muted">
                  No categories found
                </div>
              </div>
            </div>
          </div>

          <!-- Menu Item Name -->
          <div class="col-12 col-md-6">
            <label for="menuItemName" class="form-label">
              Menu Item Name <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              class="form-control"
              id="menuItemName"
              formControlName="menuItemName"
              placeholder="e.g., Margherita Pizza"
              [class.is-invalid]="f['menuItemName'].invalid && f['menuItemName'].touched">
            <div class="invalid-feedback d-block" *ngIf="f['menuItemName'].invalid && f['menuItemName'].touched">
              <span *ngIf="f['menuItemName'].errors?.['required']">Menu item name is required</span>
              <span *ngIf="f['menuItemName'].errors?.['maxlength']">Maximum 200 characters</span>
            </div>
          </div>

          <!-- Description -->
          <div class="col-12">
            <label for="menuItemDescription" class="form-label">Description</label>
            <textarea
              class="form-control"
              id="menuItemDescription"
              formControlName="menuItemDescription"
              rows="3"
              placeholder="Enter menu item description"></textarea>
          </div>

          <!-- Image URL -->
          <div class="col-12 col-md-6">
            <label for="menuItemBaseImageUrl" class="form-label">Image URL</label>
            <input
              type="url"
              class="form-control"
              id="menuItemBaseImageUrl"
              formControlName="menuItemBaseImageUrl"
              placeholder="https://example.com/image.jpg">
          </div>

          <!-- Preparation Time -->
          <div class="col-12 col-md-3">
            <label for="menuItemPreparationTime" class="form-label">Preparation Time (minutes)</label>
            <input
              type="number"
              class="form-control"
              id="menuItemPreparationTime"
              formControlName="menuItemPreparationTime"
              min="0"
              placeholder="0">
          </div>

          <!-- Is Available -->
          <div class="col-12 col-md-3">
            <label class="form-label d-block">Availability</label>
            <div class="form-check form-switch mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="menuItemIsAvailable"
                formControlName="menuItemIsAvailable">
              <label class="form-check-label" for="menuItemIsAvailable">
                Available
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Portions & Pricing -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-list-ul me-2"></i>
          Portions & Pricing
        </h5>
        <button
          type="button"
          class="btn btn-sm btn-primary"
          (click)="addPortion()">
          <i class="bi bi-plus-circle me-1"></i>
          Add Portion
        </button>
      </div>
      <div class="card-body">
        <div
          *ngFor="let portion of portions.controls; let i = index"
          class="portion-group mb-4 p-3 border rounded">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
              <i class="bi bi-box me-2"></i>
              Portion {{ i + 1 }}
            </h6>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              (click)="removePortion(i)"
              [disabled]="portions.length === 1">
              <i class="bi bi-trash"></i>
            </button>
          </div>

          <div class="row g-3" [formGroup]="getPortionFormGroup(i)">
            <!-- Portion Name -->
            <div class="col-12 col-md-6">
              <label [for]="'portionName' + i" class="form-label">
                Portion Name <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                [id]="'portionName' + i"
                formControlName="name"
                placeholder="e.g., Small, Medium, Large"
                [class.is-invalid]="portion.get('name')?.invalid && portion.get('name')?.touched">
              <div class="invalid-feedback d-block" *ngIf="portion.get('name')?.invalid && portion.get('name')?.touched">
                Portion name is required
              </div>
            </div>

            <!-- Portion Description -->
            <div class="col-12 col-md-6">
              <label [for]="'portionDesc' + i" class="form-label">Description</label>
              <input
                type="text"
                class="form-control"
                [id]="'portionDesc' + i"
                formControlName="description"
                placeholder="e.g., 12 inch pizza">
            </div>

            <!-- Portion Image URL -->
            <div class="col-12 col-md-6">
              <label [for]="'portionImage' + i" class="form-label">Image URL</label>
              <input
                type="url"
                class="form-control"
                [id]="'portionImage' + i"
                formControlName="imageUrl"
                placeholder="https://example.com/image.jpg">
            </div>

            <!-- Display Order -->
            <div class="col-12 col-md-3">
              <label [for]="'displayOrder' + i" class="form-label">Display Order</label>
              <input
                type="number"
                class="form-control"
                [id]="'displayOrder' + i"
                formControlName="displayOrder"
                min="0"
                placeholder="0">
            </div>

            <!-- Is Active -->
            <div class="col-12 col-md-3">
              <label class="form-label d-block">Status</label>
              <div class="form-check form-switch mt-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [id]="'isActive' + i"
                  formControlName="isActive">
                <label class="form-check-label" [for]="'isActive' + i">
                  Active
                </label>
              </div>
            </div>

            <!-- Portion Details -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0">
                  Portion Details <span class="text-danger">*</span>
                </label>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  (click)="addPortionDetail(i)">
                  <i class="bi bi-plus-circle me-1"></i>
                  Add Detail
                </button>
              </div>

              <div
                *ngFor="let detail of getPortionDetails(i).controls; let j = index"
                class="portion-detail-item mb-2 p-2 bg-light rounded"
                [formGroup]="getPortionDetailFormGroup(i, j)">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-5">
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      [id]="'detailName' + i + '_' + j"
                      formControlName="name"
                      placeholder="Detail name (e.g., Classic, Premium)"
                      [class.is-invalid]="detail.get('name')?.invalid && detail.get('name')?.touched">
                    <div class="invalid-feedback d-block" *ngIf="detail.get('name')?.invalid && detail.get('name')?.touched">
                      Detail name is required
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">
                        <i class="bi bi-currency-dollar"></i>
                      </span>
                      <input
                        type="number"
                        class="form-control"
                        [id]="'detailPrice' + i + '_' + j"
                        formControlName="price"
                        step="0.01"
                        min="0.01"
                        placeholder="0.00"
                        [class.is-invalid]="detail.get('price')?.invalid && detail.get('price')?.touched">
                    </div>
                    <div class="invalid-feedback d-block" *ngIf="detail.get('price')?.invalid && detail.get('price')?.touched">
                      <span *ngIf="detail.get('price')?.errors?.['required']">Price is required</span>
                      <span *ngIf="detail.get('price')?.errors?.['min']">Price must be at least 0.01</span>
                    </div>
                  </div>
                  <div class="col-12 col-md-3">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger w-100"
                      (click)="removePortionDetail(i, j)"
                      [disabled]="getPortionDetails(i).length === 1">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="portions.length === 0" class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          <p>No portions added. Click "Add Portion" to get started.</p>
        </div>
      </div>
    </div>

    <!-- Total Price Summary -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h5 class="mb-0">
              <i class="bi bi-calculator me-2"></i>
              Total Price Summary
            </h5>
            <p class="text-muted small mb-0 mt-1">Sum of all portion detail prices</p>
          </div>
          <div class="col-md-6 text-md-end">
            <div class="d-inline-block">
              <span class="badge bg-success fs-4 px-4 py-2">
                <i class="bi bi-currency-dollar me-1"></i>
                Total: {{ formatPrice(getTotalPrice()) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Buttons -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex gap-2 justify-content-end">
          <button
            type="button"
            class="btn btn-outline-secondary"
            routerLink="/menu-items"
            [disabled]="isSubmitting">
            <i class="bi bi-x-circle me-1"></i>
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isSubmitting">
            <span *ngIf="!isSubmitting">
              <i [class]="isEditMode ? 'bi bi-check-circle me-1' : 'bi bi-check-circle me-1'"></i>
              {{ isEditMode ? 'Update Menu Item' : 'Create Menu Item' }}
            </span>
            <span *ngIf="isSubmitting">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              {{ isEditMode ? 'Updating...' : 'Creating...' }}
            </span>
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

